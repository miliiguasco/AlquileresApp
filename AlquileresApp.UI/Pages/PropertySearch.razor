@page "/buscar"
@using AlquileresApp.UI.Components.Search
@using AlquileresApp.UI.Components.Property
@using AlquileresApp.Core.Interfaces
@using Microsoft.AspNetCore.Components.Web
@using AlquileresApp.Core.CasosDeUso.Propiedad

@inject IPropiedadService PropiedadService
@inject CasoDeUsoListarPropiedades CUListar
@using AlquileresApp.Core.Entidades

<HeadContent>
    <PageTitle>Buscar propiedades</PageTitle>
</HeadContent>

<div class="search-container">
    <div class="search-item">
        <LocationInput @bind-Localidad="filtros.Localidad" />
    </div>
    <div class="search-item">
        <DateRangePicker @bind-FechaInicio="filtros.FechaInicio" @bind-FechaFin="filtros.FechaFin" />
    </div>
    <div class="search-item">
        <GuestPicker @bind-Cantidad="filtros.CantidadHuespedes" />
    </div>
    <div class="search-item">
        <SearchButton OnClick="ListarPropiedades" />
    </div>
</div>

@if (propiedades is not null)
{
    <div class="propiedades-container">
        @if (propiedades.Any())
        {
            <PropertyList Propiedades="propiedades" />
        }
        else
        {
            <p>No se encontraron propiedades en la base de datos.</p>
        }
    </div>
}

@code {
    private SearchFilters filtros = new();
    private List<Propiedad> propiedades = new();

    protected override void OnInitialized()
    {
        Console.WriteLine("üöÄ Inicializando p√°gina de b√∫squeda...");
        ListarPropiedades();
    }

    private void ListarPropiedades()
    {
        Console.WriteLine("üîç Iniciando b√∫squeda de propiedades...");
        try
        {
            propiedades = CUListar.Ejecutar();
            Console.WriteLine($"üìä Propiedades encontradas: {propiedades.Count}");
            StateHasChanged(); // Forzar actualizaci√≥n de la UI
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error al listar propiedades: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }
}
