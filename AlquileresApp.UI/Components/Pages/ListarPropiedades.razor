@page "/Propiedades"
@rendermode InteractiveServer
@using AlquileresApp.Core.Entidades
@using AlquileresApp.Core.CasosDeUso.Propiedad
@using AlquileresApp.Core.CasosDeUso.Reserva
@using AlquileresApp.Core.Enumerativos
@inject CasoDeUsoListarPropiedadesFiltrado CUListarPropiedadesFiltrado
@inject CasoDeUsoCrearReserva CUReservarPropiedad


<link href="css/Filtradas.css" rel="stylesheet" />
<div class="container_listar_propiedades mt-5">
    <h2 class="tituloo">Busca tu lugar ideal</h2>

    <EditForm Model="Filtros" OnValidSubmit="Buscar">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="filtros">
            <div>
                <label>Ubicacion:</label>
                <InputText @bind-Value="Filtros.Localidad" class="input" />
            </div>

            <div>
                <label>Cantidad de personas:</label>
                <InputNumber @bind-Value="Filtros.CantidadHuespedes" class="input" />
            </div>

            <div>
                <label>Fecha de inicio:</label>
                <InputDate @bind-Value="Filtros.FechaInicio" class="input" />
            </div>

            <div>
                <label>Fecha de fin:</label>
                <InputDate @bind-Value="Filtros.FechaFin" class="input" />
            </div>

            <div>
                <button type="submit" class="btn btn-filtrar">Buscar</button>
            </div>
        </div>
    </EditForm>

    @if (Propiedades is null)
    {
        <div class="text-center">
            <p>...</p>
        </div>
    }
    else if (!Propiedades.Any())
    {
        <div class="text-center">
            <p>No hay propiedades que cumplan con los requisitos disponibles.</p>
        </div>
    }
    else
    {
        <ul class="lista-propiedades">
            @foreach (var propiedad in Propiedades)
            {
                var carouselId = $"carousel-{propiedad.Id}";

                <li class="propiedad-item">
                    <h3>@propiedad.Titulo</h3>

                    <div id="@carouselId" class="carousel slide propiedad-carousel" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            @if (propiedad.Imagenes != null && propiedad.Imagenes.Any())
                            {
                                var index = 0;
                                foreach (var imagen in propiedad.Imagenes)
                                {
                                    <div class="carousel-item @(index == 0 ? "active" : "")">
                                        <img src="@imagen.Url" class="d-block w-100 propiedad-img" alt="Imagen de @propiedad.Titulo" />
                                    </div>
                                    index++;
                                }
                            }
                            else
                            {
                                <div class="carousel-item active">
                                    <img src="Imagenes/Propiedades/iconoimagen.jpg" class="d-block w-100 propiedad-img" alt="Sin imagen" />
                                </div>
                            }
                        </div>

                        @if (propiedad.Imagenes != null && propiedad.Imagenes.Count > 1)
                        {
                            <button class="carousel-control-prev" type="button" data-bs-target="#@carouselId" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Anterior</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#@carouselId" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Siguiente</span>
                            </button>
                        }
                    </div>

                    <p>@propiedad.Descripcion</p>
                    <p><strong>Dirección:</strong> @propiedad.Direccion</p>
                    <p><strong>Localidad:</strong> @propiedad.Localidad</p>
                    <p><strong>Capacidad:</strong> @propiedad.Capacidad personas</p>
                    <p><strong>Precio por noche:</strong> $@propiedad.PrecioPorNoche</p>

                    <button class="btn btn-secondary mt-2">
                        @(PropiedadesExpandida.Contains(propiedad.Id) ? "Ver menos" : "Ver más")
                    </button>

                    @if (PropiedadesExpandida.Contains(propiedad.Id))
                    {
                        <div class="mt-3 btn-ver-mas" style="display:flex; flex-direction: column; gap: 0.5rem; max-width: 300px;">
                            <h5>Servicios:</h5>
                            @if (propiedad.ServiciosDisponibles != null && propiedad.ServiciosDisponibles.Any())
                            {
                                <ul>
                                    @foreach (var servicio in propiedad.ServiciosDisponibles)
                                    {
                                        <li>@servicio.ToString()</li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <p>No se especificaron servicios.</p>
                            }

                            <h5>Política de cancelación:</h5>
                            <p>@ObtenerDescripcionPolitica(propiedad.PoliticaCancelacion)</p>
                        </div>
                    }

                    <button
  style="
    background-color: #0A3D62;
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    width: 100%;
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  "
  onmouseover="this.style.backgroundColor='#074060'; this.style.transform='scale(1.03)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.2)'"
  onmouseout="this.style.backgroundColor='#0A3D62'; this.style.transform='scale(1)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'"
  onmousedown="this.style.transform='scale(0.98)'"
  onmouseup="this.style.transform='scale(1.03)'"
  @onclick="() => Reservar(propiedad)"
>
  Reservar
</button>

                </li>
            }
        </ul>
    }
</div>

@code {
    private SearchFilters Filtros = new();
    private List<Propiedad>? Propiedades;
    private Usuario UsuarioActual = new Cliente
    {
        Nombre = "María",
        Apellido = "Gómez",
        Email = "maria@demo.com",
        Telefono = "1234567890",
        Contraseña = "123456",
        FechaNacimiento = new DateTime(1990, 1, 1)
    };
    private HashSet<int> PropiedadesExpandida = new();

    private void Buscar()
    {
        Propiedades = CUListarPropiedadesFiltrado.Ejecutar(Filtros);
    }

    private void Reservar(Propiedad propiedad)
{
    try
    {
        if (Filtros.FechaInicio.HasValue && Filtros.FechaFin.HasValue)
        {
            CUReservarPropiedad.Ejecutar(UsuarioActual.Id, propiedad.Id, Filtros.FechaInicio.Value, Filtros.FechaFin.Value);
            // Mostrar mensaje de éxito o redirigir, como prefieras
            Console.WriteLine("Reserva exitosa");
        }
        else
        {
            Console.WriteLine("Debe seleccionar una fecha de inicio y fin.");
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Error al reservar: {ex.Message}");
        // Mostrar error al usuario si lo necesitás
    }
}/*
    private void Buscar()
    {
        if (PropiedadesExpandida.Contains(propiedadId))
            PropiedadesExpandida.Remove(propiedadId);
        else
            PropiedadesExpandida.Add(propiedadId);
{
    
    }*/

    private string ObtenerDescripcionPolitica(PoliticasDeCancelacion politica)
    {
        return politica switch
        {
            PoliticasDeCancelacion.Anticipo20_72hs => "Requiere 20% de anticipo y permite cancelación hasta 72hs antes.",
            PoliticasDeCancelacion.SinAnticipo_NoCancelable => "No requiere anticipo, pero no permite cancelaciones.",
            PoliticasDeCancelacion.PagoTotal_48hs_50 => "Pago total por adelantado, permite cancelación hasta 48hs antes con 50% de reintegro.",
            _ => "No especificada."
        };
    }
}
